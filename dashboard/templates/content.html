{% extends "base.html" %}
{% block active_page %}content{% endblock %}
{% block page_heading %}Content Management{% endblock %}
{% block content %}


<body>
  
<section class="bg-black text-white py-5 px-4" >
    <div >
          <h1 style="padding-left: 2in;"class="display-5 fw-semibold">Content</h1>


    <div class="d-flex gap-4 mt-4"  style="padding-left: 2in;">
        <button class="tab active" data-tab="files">Files</button>
        <button class="tab" data-tab="lessons">Lessons</button>
      </div>
    </div>
  </section>

  <div class="container">
    <!-- FILES TAB -->
    <div id="files" class="tab-content active">
<div class="button-container">
  <button class="add-btn" onclick="openModal('addFileModal')">Add File</button>
</div>      <table>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>File</th>
          <th>Actions</th>
        </tr>
        {% for file in files %}
        <tr>
          <td>{{ file.title }}</td>
          <td>{{ file.description }}</td>
          <td><a href="{{ file.file.url }}" target="_blank">View</a></td>
          <td>
            <button onclick="openEditFileModal('{{ file.id }}', '{{ file.title }}', '{{ file.description }}')">Edit</button>
            <a href="{% url 'delete_file' file.id %}" onclick="return confirm('Are you sure you want to delete this file?')">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No files yet.</td></tr>
        {% endfor %}
      </table>
    </div>

    <!-- LESSONS TAB -->
    <div id="lessons" class="tab-content">
     <div class="button-container"> <button class="add-btn" onclick="openModal('addLessonModal')">Add Lesson</button></div>
      <table>
        <tr>
          <th>Title</th>
          <th>Subtitle</th>
          <th>Message</th>
          <th>Actions</th>
        </tr>
        {% for lesson in lessons %}
        <tr>
          <td>{{ lesson.title }}</td>
          <td>{{ lesson.subtitle }}</td>
          <td>{{ lesson.message|truncatewords:15 }}</td>
          <td>
            <button onclick="openEditLessonModal('{{ lesson.id }}', '{{ lesson.title }}', '{{ lesson.subtitle }}', `{{ lesson.message|escapejs }}`)">Edit</button>
            <a href="{% url 'delete_lesson' lesson.id %}" onclick="return confirm('Delete this lesson?')">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No lessons yet.</td></tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <!-- ADD FILE MODAL -->
  <div id="addFileModal" class="modal">
    <div class="modal-modern">
      <div class="modal-header">
        <h2>Add File</h2>
      </div>
      <form action="{% url 'add_file' %}" method="post" enctype="multipart/form-data" class="modern-form">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label>Title</label>
            <input type="text" name="title" placeholder="Enter file title" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea name="description" placeholder="Enter description" class="form-control"></textarea>
          </div>
          <div class="form-group">
            <label>Upload File</label>
            <input type="file" name="file" id="fileInput" required>
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
              <div class="upload-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="upload-title" id="fileTitle">Choose File</div>
              <div class="upload-subtitle" id="fileSubtitle">Click to browse</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modal btn-cancel" onclick="closeModal('addFileModal')">Cancel</button>
          <button type="submit" class="btn-modal btn-next">Add File</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EDIT FILE MODAL -->
  <div id="editFileModal" class="modal">
    <div class="modal-modern">
      <div class="modal-header">
        <h2>Edit File</h2>
      </div>
      <form id="editFileForm" method="post" enctype="multipart/form-data" class="modern-form">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label>Title</label>
            <input type="text" name="title" id="editFileTitle" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea name="description" id="editFileDescription" class="form-control"></textarea>
          </div>
          <div class="form-group">
            <label>Replace File (optional)</label>
            <input type="file" name="file">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modal btn-cancel" onclick="closeModal('editFileModal')">Cancel</button>
          <button type="submit" class="btn-modal btn-next">Update File</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ADD LESSON MODAL -->
  <div id="addLessonModal" class="modal">
    <div class="modal-modern">
      <div class="modal-header">
        <h2>Create lesson</h2>
      </div>

      <form action="{% url 'add_lesson' %}" method="post" enctype="multipart/form-data" class="modern-form">
        {% csrf_token %}
        
        <div class="modal-body">
          <div class="form-group">
            <label>Name</label>
            <input type="text" name="title" placeholder="Enter lesson name" class="form-control" required>
          </div>

          <div class="form-group">
            <label>Subtitle</label>
            <input type="text" name="subtitle" placeholder="Enter subtitle" class="form-control">
          </div>

          <div class="form-group">
            <label>Message*</label>
            <div class="toolbar">
              <select>
                <option>Normal</option>
              </select>
              <div class="toolbar-separator"></div>
              <button type="button" class="toolbar-btn" title="Bold">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M4 2h5a3 3 0 0 1 0 6H4V2z" stroke="currentColor" stroke-width="1.5"/>
                  <path d="M4 8h6a3 3 0 0 1 0 6H4V8z" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </button>
              <button type="button" class="toolbar-btn" title="Italic">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M7 2h6M3 14h6M10 2l-4 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
              <button type="button" class="toolbar-btn" title="Underline">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M4 2v5a4 4 0 0 0 8 0V2M3 14h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
            <textarea name="message" placeholder="Type your message here..." class="form-control" id="lessonMessage" required></textarea>
            <div class="action-buttons">
              <button type="button" class="action-btn" onclick="insertEmoji()">
                <span>üòä</span>
                Add an emoji
              </button>
              <button type="button" class="action-btn" onclick="insertFirstName()">
                <span>[ ]</span>
                Add "First name"
              </button>
            </div>
          </div>

          <div class="section-title">Media</div>
          
          <div class="upload-grid">
            <div class="upload-box" onclick="document.getElementById('id_image').click()">
              <div class="upload-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="upload-title">Images</div>
              <div class="upload-subtitle">Drop files here or click to Browse</div>
            </div>

            <div class="upload-box" onclick="document.getElementById('id_attachments').click()">
              <div class="upload-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="upload-title">Upload file</div>
              <div class="upload-subtitle">Drop files here or click to Browse</div>
            </div>
          </div>

          <div class="media-row">
            <div class="media-box" id="videoRecordBox" onclick="toggleVideoRecording()">
              <div class="media-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="5" width="18" height="14" rx="2"/>
                  <circle cx="12" cy="12" r="3" fill="currentColor"/>
                </svg>
              </div>
              <div class="media-title">Video recording</div>
              <div class="media-subtitle" id="video-status">Click to start recording</div>
              <div id="video-preview" class="d-none rec-preview">
                <video id="video-player" controls></video>
              </div>
            </div>

            <div class="media-box" id="audioRecordBox" onclick="toggleAudioRecording()">
              <div class="media-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/>
                  <path d="M19 10v1a7 7 0 0 1-14 0v-1M12 18v4M8 22h8"/>
                </svg>
              </div>
              <div class="media-title">Record audio</div>
              <div class="media-subtitle" id="audio-status">Click to record audio</div>
              <div id="audio-preview" class="d-none rec-preview">
                <audio id="audio-player" controls></audio>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-modal btn-cancel" onclick="closeModal('addLessonModal')">Cancel</button>
          <button type="submit" class="btn-modal btn-next">Create Lesson</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EDIT LESSON MODAL -->
  <div id="editLessonModal" class="modal">
    <div class="modal-modern">
      <div class="modal-header">
        <h2>Edit Lesson</h2>
      </div>
      <form id="editLessonForm" method="post" class="modern-form">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-group">
            <label>Title</label>
            <input type="text" name="title" id="editLessonTitle" class="form-control" required>
          </div>
          <div class="form-group">
            <label>Subtitle</label>
            <input type="text" name="subtitle" id="editLessonSubtitle" class="form-control">
          </div>
          <div class="form-group">
            <label>Message</label>
            <textarea name="message" id="editLessonMessage" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modal btn-cancel" onclick="closeModal('editLessonModal')">Cancel</button>
          <button type="submit" class="btn-modal btn-next">Update Lesson</button>
        </div>
      </form>
    </div>
  </div>
<script>
document.querySelector('form[action="{% url "add_lesson" %}"]').addEventListener('submit', async (e) => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  console.log("üü° [DEBUG] Submitting lesson form...");
  for (let [key, value] of formData.entries()) {
    console.log(`‚û°Ô∏è ${key}:`, value);
  }

  try {
    const res = await fetch(form.action, {
      method: 'POST',
      body: formData
    });
    console.log("üü¢ [DEBUG] Response status:", res.status);
    const text = await res.text();
    console.log("üü¢ [DEBUG] Response text:", text);

    if (res.ok) {
      alert("‚úÖ Lesson added successfully!");
      window.location.reload();
    } else {
      alert("‚ö†Ô∏è Lesson add failed. Check console logs for more details.");
    }
  } catch (err) {
    console.error("üî¥ [DEBUG] Error while submitting:", err);
  }
});
</script>
<script>
    // Tab switching
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      contents.forEach(c => c.classList.remove("active"));
      t.classList.add("active");
      document.getElementById(t.dataset.tab).classList.add("active");
    }));

    // Modal functions
    function openModal(id) { 
      document.getElementById(id).classList.add('active'); 
    }
    
    function closeModal(id) { 
      document.getElementById(id).classList.remove('active');
      if (id === 'addLessonModal') {
        stopAllRecordings();
      }
    }

    function openEditFileModal(id, title, desc) {
      document.getElementById("editFileForm").action = `/edit-file/${id}/`;
      document.getElementById("editFileTitle").value = title;
      document.getElementById("editFileDescription").value = desc;
      openModal('editFileModal');
    }

    function openEditLessonModal(id, title, subtitle, msg) {
      document.getElementById("editLessonForm").action = `/edit-lesson/${id}/`;
      document.getElementById("editLessonTitle").value = title;
      document.getElementById("editLessonSubtitle").value = subtitle;
      document.getElementById("editLessonMessage").value = msg;
      openModal('editLessonModal');
    }

    // Text editing functions
    function insertEmoji() {
      const emoji = prompt('Enter an emoji:');
      if (emoji) {
        const textarea = document.getElementById('lessonMessage');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        textarea.value = textarea.value.substring(0, start) + emoji + textarea.value.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
        textarea.focus();
      }
    }

    function insertFirstName() {
      const textarea = document.getElementById('lessonMessage');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const placeholder = '[First Name]';
      textarea.value = textarea.value.substring(0, start) + placeholder + textarea.value.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + placeholder.length;
      textarea.focus();
    }

    // Close modal on outside click
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
        stopAllRecordings();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
          modal.classList.remove('active');
          stopAllRecordings();
        });
      }
    });

    // File selection for Add File modal
    const fileInputEl = document.getElementById('fileInput');
    if (fileInputEl) {
      fileInputEl.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          document.getElementById('fileTitle').textContent = 'File selected';
          document.getElementById('fileSubtitle').textContent = e.target.files[0].name;
        }
      });
    }

    // Recording utilities
    const toFile = (blob, base) => {
      const t = blob.type || 'application/octet-stream';
      let ext = 'bin';
      if (t.includes('webm')) ext = 'webm';
      else if (t.includes('mp4')) ext = 'mp4';
      else if (t.includes('ogg')) ext = 'ogg';
      else if (t.includes('mpeg')) ext = 'mpg';
      const name = `${base}_${Date.now()}.${ext}`;
      return new File([blob], name, { type: t });
    };

    const setFileInput = (input, file) => {
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
    };

    const pickMime = (types) => {
      if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) return '';
      for (const t of types) if (MediaRecorder.isTypeSupported(t)) return t;
      return '';
    };

    // Video recording
    let vStream = null, vRecorder = null, vChunks = [], vRecording = false;

    async function toggleVideoRecording() {
      if (vRecording) {
        stopVideoRecording();
      } else {
        await startVideoRecording();
      }
    }

    async function startVideoRecording() {
      try {
        vStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        vChunks = [];
        const mime = pickMime(['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/mp4','video/webm']);
        vRecorder = new MediaRecorder(vStream, mime ? { mimeType: mime } : {});
        
        vRecorder.ondataavailable = e => { if (e.data?.size) vChunks.push(e.data); };
        vRecorder.onstop = () => {
          const blob = new Blob(vChunks, { type: vRecorder.mimeType || 'video/webm' });
          const file = toFile(blob, 'lesson_video');
          const videoInput = document.getElementById('id_video');
          if (videoInput) setFileInput(videoInput, file);

          const player = document.getElementById('video-player');
          player.src = URL.createObjectURL(blob);
          document.getElementById('video-preview').classList.remove('d-none');
          
          document.getElementById('video-status').textContent = 'Video recorded - Click to record again';
        };
        
        vRecorder.start();
        vRecording = true;
        document.getElementById('video-status').innerHTML = '<span class="recording-indicator"></span>Recording... Click to stop';
        
        const videoBox = document.getElementById('videoRecordBox');
        videoBox.style.background = '#fee2e2';
        videoBox.style.borderColor = '#ef4444';
      } catch (e) {
        alert('Camera/microphone not available or permission denied.');
        console.error(e);
      }
    }

    function stopVideoRecording() {
      if (vRecorder && vRecorder.state !== 'inactive') {
        vRecorder.stop();
      }
      if (vStream) {
        vStream.getTracks().forEach(t => t.stop());
      }
      vRecording = false;
      
      const videoBox = document.getElementById('videoRecordBox');
      videoBox.style.background = '';
      videoBox.style.borderColor = '';
    }

    // Audio recording
    let aStream = null, aRecorder = null, aChunks = [], aRecording = false;

    async function toggleAudioRecording() {
      if (aRecording) {
        stopAudioRecording();
      } else {
        await startAudioRecording();
      }
    }

    async function startAudioRecording() {
      try {
        aStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        aChunks = [];
        const mime = pickMime(['audio/webm;codecs=opus','audio/mp4','audio/ogg','audio/webm']);
        aRecorder = new MediaRecorder(aStream, mime ? { mimeType: mime } : {});
        
        aRecorder.ondataavailable = e => { if (e.data?.size) aChunks.push(e.data); };
        aRecorder.onstop = () => {
          const blob = new Blob(aChunks, { type: aRecorder.mimeType || 'audio/webm' });
          const file = toFile(blob, 'lesson_audio');
          const attInput = document.getElementById('id_attachments');
          if (attInput) setFileInput(attInput, file);

          const player = document.getElementById('audio-player');
          player.src = URL.createObjectURL(blob);
          document.getElementById('audio-preview').classList.remove('d-none');
          
          document.getElementById('audio-status').textContent = 'Audio recorded - Click to record again';
        };
        
        aRecorder.start();
        aRecording = true;
        document.getElementById('audio-status').innerHTML = '<span class="recording-indicator"></span>Recording... Click to stop';
        
        const audioBox = document.getElementById('audioRecordBox');
        audioBox.style.background = '#fee2e2';
        audioBox.style.borderColor = '#ef4444';
      } catch (e) {
        alert('Microphone not available or permission denied.');
        console.error(e);
      }
    }

    function stopAudioRecording() {
      if (aRecorder && aRecorder.state !== 'inactive') {
        aRecorder.stop();
      }
      if (aStream) {
        aStream.getTracks().forEach(t => t.stop());
      }
      aRecording = false;
      
      const audioBox = document.getElementById('audioRecordBox');
      audioBox.style.background = '';
      audioBox.style.borderColor = '';
    }

    function stopAllRecordings() {
      stopVideoRecording();
      stopAudioRecording();
      
      document.getElementById('video-status').textContent = 'Click to start recording';
      document.getElementById('audio-status').textContent = 'Click to record audio';
      document.getElementById('video-preview').classList.add('d-none');
      document.getElementById('audio-preview').classList.add('d-none');
    }

    // File upload handlers
    document.addEventListener('DOMContentLoaded', function() {
      const imageInput = document.getElementById('id_image');
      if (imageInput) {
        imageInput.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            const imageBox = document.querySelector('.upload-grid .upload-box:nth-child(1)');
            if (imageBox) {
              imageBox.style.background = '#dcfce7';
              imageBox.style.borderColor = '#22c55e';
              imageBox.querySelector('.upload-title').textContent = 'Image selected';
              imageBox.querySelector('.upload-subtitle').textContent = e.target.files[0].name;
            }
          }
        });
      }

      const fileInput = document.getElementById('id_attachments');
      if (fileInput) {
        fileInput.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            const fileBox = document.querySelector('.upload-grid .upload-box:nth-child(2)');
            if (fileBox) {
              fileBox.style.background = '#dcfce7';
              fileBox.style.borderColor = '#22c55e';
              fileBox.querySelector('.upload-title').textContent = 'File selected';
              fileBox.querySelector('.upload-subtitle').textContent = e.target.files[0].name;
            }
          }
        });
      }
    });
</script>
{% endblock %}