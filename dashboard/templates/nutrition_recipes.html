{% extends "base.html" %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<style>
  .chip { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:6px 10px; border-radius:999px; background:#f3f4f6; }
  .chip .dot { width:8px; height:8px; border-radius:999px; display:inline-block; }
</style>

<!-- Header -->
<section class="bg-black text-white py-8 px-6">
  <h1  style="padding-left: 2in;"class="text-4xl font-bold">Nutrition</h1>
  <div  style="padding-left: 2in;" class="flex space-x-8 mt-4 text-gray-300">
    <a href="{% url 'nutrition_recipes' %}" class="hover:text-white {% if active_tab == 'recipes' %}border-b-2 border-white text-white{% endif %}">Recipes</a>
    <a href="{% url 'nutrition' %}" class="hover:text-white {% if active_tab == 'ingredients' %}border-b-2 border-white text-white{% endif %}">Ingredients</a>
    <a href="{% url 'nutrition_templates' %}" class="hover:text-white {% if active_tab == 'templates' %}border-b-2 border-white text-white{% endif %}">Templates</a>
  </div>
</section>

<!-- Main -->
<main class="bg-gray-50 px-8 py-12 min-h-screen">
  <!-- Topbar -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
    <p class="text-sm font-semibold">Showing {{ meals|length }} recipes</p>

    <div class="flex items-center gap-2">
      <div class="relative">
        <input type="text" placeholder="Search" class="pl-9 pr-3 py-2 border rounded-lg text-sm bg-white" />
        <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.3-4.3M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/>
        </svg>
      </div>
      <select class="py-2 px-3 border rounded-lg text-sm bg-white">
        <option>Tag</option>
        <option>Breakfast</option>
        <option>Lunch</option>
        <option>Dinner</option>
        <option>Snack</option>
      </select>
      <button data-modal-open="#recipeModal" class="bg-black text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-800">
        Create a Recipe
      </button>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white rounded-lg shadow-sm overflow-hidden">
    <table class="w-full text-left">
      <thead class="bg-gray-50 border-b">
        <tr class="text-sm">
          <th class="py-3 px-4 font-semibold">Name</th>
          <th class="py-3 px-4 font-semibold">Language</th>
          <th class="py-3 px-4 font-semibold">Library</th>
          <th class="py-3 px-4 font-semibold">Macro split</th>
          <th class="py-3 px-4 font-semibold">Calories</th>
          <th class="py-3 px-4 font-semibold">Time</th>
          <th class="py-3 px-4 font-semibold">Meal type</th>
        </tr>
      </thead>
      <tbody id="recipesBody">
        {% if meals %}
          {% for r in meals %}
          <tr class="border-b hover:bg-gray-50">
            <td class="py-3 px-4">
              <div class="font-medium">{{ r.name }}</div>
              <div class="text-xs text-gray-500">{{ r.description|default_if_none:""|truncatewords:14 }}</div>
            </td>
            <td class="py-3 px-4 text-sm">{{ r.language|default:"‚Äî" }}</td>
            <td class="py-3 px-4 text-sm">My library</td>
            <td class="py-3 px-4 text-sm">
              P {{ r.protein|default:0 }}g ‚Ä¢ C {{ r.carbs|default:0 }}g ‚Ä¢ F {{ r.fats|default:0 }}g
            </td>
            <td class="py-3 px-4 text-sm">{{ r.calories|default:"‚Äî" }}</td>
            <td class="py-3 px-4 text-sm">
              {% with t=0 %}
                {% if r.preparation_time %}{% widthratio r.preparation_time 1 1 as t %}{% endif %}
                {% if r.cooking_time %}{% widthratio t|add:r.cooking_time 1 1 as t %}{% endif %}
                {% if r.preparation_time or r.cooking_time %}{{ r.preparation_time|default:0|add:r.cooking_time|default:0 }} min{% else %}‚Äî{% endif %}
              {% endwith %}
            </td>
            <td class="py-3 px-4 capitalize text-sm">{{ r.meal_type|default:"‚Äî" }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr id="recipesEmptyRow">
            <td colspan="7" class="py-16 text-center">
              <div class="mx-auto w-10 h-10 flex items-center justify-center bg-black text-white rounded-full mb-4">?</div>
              <div class="font-semibold">No recipes found</div>
              <div class="text-sm text-gray-500">Recipes are the foundation of your nutrition plans. Mark favorites to see them here.</div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</main>

<!-- Create recipe modal -->
<div id="recipeModal" class="modal-overlay fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
  <div class="relative bg-white rounded-2xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="recipeTitle">
    <button type="button" aria-label="Close" data-modal-close="#recipeModal" class="absolute right-4 top-4 text-gray-500 hover:text-black">‚úï</button>

    <h2 id="recipeTitle" class="text-2xl font-bold mb-4">Create recipe</h2>
    <div id="recipeErrors" class="bg-red-50 text-red-700 border border-red-200 rounded p-3 text-sm mb-4 hidden"></div>

    <form id="recipeForm" method="post" action="{% url 'recipe_create' %}">
      {% csrf_token %}

      <!-- Upload + name + chips -->
      <div class="flex items-start gap-4 mb-4">
        <label class="w-16 h-16 border-2 border-dashed rounded-lg flex items-center justify-center text-gray-400 cursor-pointer">
          ‚¨ÜÔ∏è
          <input type="file" name="image" class="hidden" />
        </label>
        <input name="name" type="text" placeholder="Recipe name" class="flex-1 p-2 border rounded bg-gray-50" required>
      </div>

      <div class="flex items-center gap-2 mb-4">
        <span class="chip"><span class="dot bg-pink-500"></span> Protein <span id="chipP">0g</span></span>
        <span class="chip"><span class="dot bg-green-500"></span> Carbs <span id="chipC">0g</span></span>
        <span class="chip"><span class="dot bg-blue-500"></span> Fat <span id="chipF">0g</span></span>
      </div>

      <textarea name="description" rows="2" placeholder="Short description" class="w-full border rounded p-2 bg-gray-50 mb-4"></textarea>

      <!-- Ingredients add row -->
      <div class="mb-2">
        <div class="relative mb-2">
          <input id="ingName" type="text" placeholder="Search ingredients and spices" class="w-full border rounded p-2 pr-9" />
          <svg class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </div>
        <div class="grid grid-cols-4 gap-2">
          <input id="ingP" type="number" step="0.1" placeholder="P (g)" class="border rounded p-2">
          <input id="ingC" type="number" step="0.1" placeholder="C (g)" class="border rounded p-2">
          <input id="ingF" type="number" step="0.1" placeholder="F (g)" class="border rounded p-2">
          <button type="button" id="addIngBtn" class="bg-black text-white rounded p-2 hover:bg-gray-800">Add</button>
        </div>
      </div>

      <!-- Ingredient list -->
      <div id="ingList" class="border rounded p-3 text-sm mb-4 text-gray-600">
        Ingredients will show here
      </div>

      <!-- Flexible amounts note -->
      <div class="flex items-start gap-3 mb-4">
        <span class="text-xl leading-6">üîì</span>
        <p class="text-sm">Flexible ingredient amounts<br><span class="text-gray-500">Calories and ingredient amounts will scale to fit clients calories intake</span></p>
      </div>

      <!-- Instructions -->
      <textarea name="instructions" rows="4" placeholder="Instructions" class="w-full border rounded p-3 bg-gray-50 mb-4"></textarea>

      <!-- Times -->
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="text-xs text-gray-500">Preparation time (min)</label><input name="preparation_time" type="number" class="border p-2 rounded w-full"></div>
        <div><label class="text-xs text-gray-500">Cooking time (min)</label><input name="cooking_time" type="number" class="border p-2 rounded w-full"></div>
      </div>

      <!-- Selects -->
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div>
          <label class="text-xs text-gray-500">Meal type</label>
          <select name="meal_type" class="border p-2 rounded w-full" required>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500">Kind</label>
          <select class="border p-2 rounded w-full">
            <option>Standard</option>
            <option>Vegan</option>
            <option>Vegetarian</option>
            <option>Keto</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500">Language</label>
          <select class="border p-2 rounded w-full">
            <option>English (US)</option>
            <option>English (UK)</option>
          </select>
        </div>
      </div>

      <!-- Hidden totals for server -->
      <input type="hidden" name="protein" id="totalP" value="0">
      <input type="hidden" name="carbs" id="totalC" value="0">
      <input type="hidden" name="fats" id="totalF" value="0">
      <input type="hidden" name="calories" id="totalKcal" value="0">

      <div class="flex justify-end gap-3">
        <button type="button" data-modal-close="#recipeModal" class="hover:underline">Cancel</button>
        <button id="recipeSubmitBtn" class="bg-black text-white px-5 py-2 rounded">Submit</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Modal open/close
  document.addEventListener('click', (e) => {
    const opener = e.target.closest('[data-modal-open]');
    if (opener) document.querySelector(opener.getAttribute('data-modal-open'))?.classList.remove('hidden');
    const closer = e.target.closest('[data-modal-close]');
    if (closer) document.querySelector(closer.getAttribute('data-modal-close'))?.classList.add('hidden');
    if (e.target.classList?.contains('modal-overlay')) e.target.classList.add('hidden');
  });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden')); });

  // Ingredient list + totals
  const ingList = document.getElementById('ingList');
  const chipP = document.getElementById('chipP'), chipC = document.getElementById('chipC'), chipF = document.getElementById('chipF');
  const totalP = document.getElementById('totalP'), totalC = document.getElementById('totalC'), totalF = document.getElementById('totalF'), totalKcal = document.getElementById('totalKcal');

  function fmt(n){ return (Math.round((n ?? 0) * 10)/10).toFixed(1) }
  function recalcTotals() {
    let p=0,c=0,f=0;
    ingList.querySelectorAll('[data-p]').forEach(row => {
      p += parseFloat(row.dataset.p||0);
      c += parseFloat(row.dataset.c||0);
      f += parseFloat(row.dataset.f||0);
    });
    chipP.textContent = fmt(p)+'g'; chipC.textContent = fmt(c)+'g'; chipF.textContent = fmt(f)+'g';
    totalP.value = fmt(p); totalC.value = fmt(c); totalF.value = fmt(f);
    totalKcal.value = Math.round(p*4 + c*4 + f*9);
  }

  document.getElementById('addIngBtn').addEventListener('click', () => {
    const name = document.getElementById('ingName').value.trim();
    const p = parseFloat(document.getElementById('ingP').value||0);
    const c = parseFloat(document.getElementById('ingC').value||0);
    const f = parseFloat(document.getElementById('ingF').value||0);
    if (!name || (p===0 && c===0 && f===0)) { alert('Add a name and at least one macro.'); return; }

    // Replace placeholder text on first add
    if (ingList.textContent.trim() === 'Ingredients will show here') ingList.innerHTML = '';

    const li = document.createElement('div');
    li.className = 'flex items-center justify-between border rounded p-2 mb-2';
    li.dataset.p=p; li.dataset.c=c; li.dataset.f=f;
    const kcal = Math.round(p*4+c*4+f*9);
    li.innerHTML = `
      <div class="text-sm">
        <div class="font-medium">${name}</div>
        <div class="text-xs text-gray-500">P ${fmt(p)}g ‚Ä¢ C ${fmt(c)}g ‚Ä¢ F ${fmt(f)}g ‚Ä¢ ${kcal} kcal</div>
      </div>
      <button type="button" class="text-gray-500 hover:text-black" aria-label="Remove">‚úï</button>
    `;
    li.querySelector('button').addEventListener('click', () => { li.remove(); if (!ingList.children.length) ingList.textContent='Ingredients will show here'; recalcTotals(); });
    ingList.appendChild(li);

    document.getElementById('ingName').value='';
    document.getElementById('ingP').value='';
    document.getElementById('ingC').value='';
    document.getElementById('ingF').value='';
    recalcTotals();
  });

  // Submit via AJAX
  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('#recipeForm');
    if (!form) return;
    e.preventDefault();

    // ensure totals are synced
    recalcTotals();

    const btn = document.getElementById('recipeSubmitBtn');
    const errBox = document.getElementById('recipeErrors');
    errBox.classList.add('hidden'); errBox.innerHTML='';
    btn.disabled = true; btn.textContent='Saving...';

    try {
      const res = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value },
        body: new FormData(form)
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        const errs = data.errors || {};
        errBox.innerHTML = Object.entries(errs).map(([f, m]) => `<div><strong>${f}</strong>: ${Array.isArray(m)?m.join(', '):m}</div>`).join('') || 'Failed to save.';
        errBox.classList.remove('hidden');
        return;
      }

      // remove empty row on first insert
      document.getElementById('recipesEmptyRow')?.remove();

      // prepend new row
      const tb = document.getElementById('recipesBody');
      const timeText = data.row.preparation_time ? `${data.row.preparation_time} min` : '‚Äî';
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-gray-50';
      tr.innerHTML = `
        <td class="py-3 px-4">
          <div class="font-medium">${data.row.name}</div>
          <div class="text-xs text-gray-500">${(data.row.description || '').slice(0, 100)}</div>
        </td>
        <td class="py-3 px-4 text-sm">${data.row.language || '‚Äî'}</td>
        <td class="py-3 px-4 text-sm">My library</td>
        <td class="py-3 px-4 text-sm">P ${data.row.protein}g ‚Ä¢ C ${data.row.carbs}g ‚Ä¢ F ${data.row.fats}g</td>
        <td class="py-3 px-4 text-sm">${data.row.calories}</td>
        <td class="py-3 px-4 text-sm">${timeText}</td>
        <td class="py-3 px-4 capitalize text-sm">${data.row.meal_type || ''}</td>
      `;
      tb.prepend(tr);

      // reset + close
      form.reset();
      ingList.innerHTML = 'Ingredients will show here';
      recalcTotals();
      document.getElementById('recipeModal')?.classList.add('hidden');
    } catch (err) {
      errBox.textContent = 'Unexpected error. Please try again.';
      errBox.classList.remove('hidden');
    } finally {
      btn.disabled = false; btn.textContent='Submit';
    }
  });
</script>
{% endblock %}