{% extends "base.html" %}
{% block active_page %}content{% endblock %}
{% block content %}
<style>
  /* Utilities (if Bootstrap isn‚Äôt loaded in base.html) */
  .d-none{ display:none !important; }
  .w-100{ width:100% !important; }
  .d-flex{ display:flex !important; }
  .gap-2{ gap:.5rem !important; }
  .ms-auto{ margin-left:auto !important; }
  .btn{ border:none; border-radius:8px; padding:8px 12px; font-size:13px; cursor:pointer; }
  .btn-light{ background:#eee; color:#000; }
  .btn-dark{ background:#000; color:#fff; }
  .btn-outline-secondary{ background:#f2f2f2; color:#000; border:1px solid #ddd; }
  .btn-outline-secondary:hover{ background:#eaeaea; }
  .btn-sm{ padding:6px 10px; font-size:12px; }

  /* Design-style upload blocks (optional) */
  .upload-block{ display:flex; align-items:center; gap:12px; background:#f6f7f9; border:1px solid #eee; border-radius:12px; padding:14px; cursor:pointer; margin-bottom:10px; }
  .ub-icon{ width:36px; height:36px; background:#fff; border:1px solid #eee; border-radius:8px; display:grid; place-items:center; font-size:18px; }
  .ub-title{ font-weight:600; font-size:14px; color:#111; }
  .ub-sub{ font-size:12px; color:#888; }

  /* Recorder layout: two cards side-by-side (wrap on small screens) */
  .rec-grid{ display:grid; grid-template-columns: 1fr; gap:16px; }
  @media (min-width: 768px){ .rec-grid{ grid-template-columns: 1fr 1fr; } }

  .rec-card{ background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; }
  .rec-title{ font-weight:600; font-size:14px; margin-bottom:8px; }
  .rec-live, .rec-prev{ width:100%; aspect-ratio:16/9; background:#f2f2f2; border-radius:8px; }
  .rec-audio{ width:100%; }

  /* Hide raw inputs if you want the clean design */
  #id_image, #id_attachments { display:none; }
</style>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f5f6f8;
  }

  .container {
    padding: 30px;
  }

  .bg-blk {
    background: #000;
    padding: 20px 30px;
    margin-left: -28px;
    margin-right: -28px;
    color: white;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    margin-bottom: 25px;
  }

  .bg-blk h1 {
    font-size: 26px;
    font-weight: bold;
    margin: 0;
  }

  .tabs {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
  }

  .tab {
    background: #000;
    border: none;
    color: white;
    font-size: 15px;
    padding: 10px 18px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.2s;
  }

  .tab:hover {
    background: #222;
  }

  .tab.active {
    background: #444;
    font-weight: bold;
  }

  .add-btn {
    background: #000;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    cursor: pointer;
    margin-bottom: 15px;
    transition: background 0.2s;
  }

  .add-btn:hover {
    background: #333;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  th, td {
    text-align: left;
    padding: 14px;
    font-size: 14px;
  }

  th {
    background: #f2f2f2;
    color: #555;
    font-weight: bold;
  }

  tr:nth-child(even) {
    background: #fafafa;
  }

  td a, td button {
    font-size: 13px;
    color: #000;
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: underline;
    margin-right: 10px;
  }

  td a:hover, td button:hover {
    color: #444;
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal.active {
    display: flex;
  }

  .modal-content, .modal form {
    background: #fff;
    width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }

  .modal h2 {
    margin-top: 0;
    font-size: 20px;
    margin-bottom: 20px;
    color: #111;
  }

  input[type="text"], textarea, input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: #f9f9f9;
    font-size: 14px;
    margin-bottom: 15px;
  }

  textarea {
    resize: vertical;
    min-height: 80px;
  }
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}
  .modal button {
    background: #000;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .modal button:hover {
    background: #333;
  }

  .modal button[type="button"] {
    background: #ccc;
    color: #000;
  }

  .modal button[type="button"]:hover {
    background: #bbb;
  }
</style>

<body>
  <section class="bg-blk">
    <div class="container">
      <h1  style="padding-left: 2in;">Content Management</h1>
    </div>

  <div class="content-container">
    <div class="tabs">
      <button class="tab active" data-tab="files">Files</button>
      <button class="tab" data-tab="lessons">Lessons</button>
    </div>
  </section>

    <!-- FILES TAB -->
    <div id="files" class="tab-content active">
      <button class="add-btn" onclick="openModal('addFileModal')">+ Add File</button>
      <table>
        <tr>
          <th>Title</th>
          <th>Description</th>
          <th>File</th>
          <th>Actions</th>
        </tr>
        {% for file in files %}
        <tr>
          <td>{{ file.title }}</td>
          <td>{{ file.description }}</td>
          <td><a href="{{ file.file.url }}" target="_blank">View</a></td>
          <td>
            <button onclick="openEditFileModal('{{ file.id }}', '{{ file.title }}', '{{ file.description }}')">Edit</button>
            <a href="{% url 'delete_file' file.id %}" onclick="return confirm('Are you sure you want to delete this file?')">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No files yet.</td></tr>
        {% endfor %}
      </table>
    </div>

    <!-- LESSONS TAB -->
    <div id="lessons" class="tab-content">
      <button class="add-btn" onclick="openModal('addLessonModal')">+ Add Lesson</button>
      <table>
        <tr>
          <th>Title</th>
          <th>Subtitle</th>
          <th>Message</th>
          <th>Actions</th>
        </tr>
        {% for lesson in lessons %}
        <tr>
          <td>{{ lesson.title }}</td>
          <td>{{ lesson.subtitle }}</td>
          <td>{{ lesson.message|truncatewords:15 }}</td>
          <td>
            <button onclick="openEditLessonModal('{{ lesson.id }}', '{{ lesson.title }}', '{{ lesson.subtitle }}', '{{ lesson.message }}')">Edit</button>
            <a href="{% url 'delete_lesson' lesson.id %}" onclick="return confirm('Delete this lesson?')">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No lessons yet.</td></tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <!-- MODALS -->
  <div id="addFileModal" class="modal">
    <form action="{% url 'add_file' %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <h2>Add File</h2>
      {{ file_form.as_p }}
      <button type="submit">Save</button>
      <button type="button" onclick="closeModal('addFileModal')">Cancel</button>
    </form>
  </div>

  <div id="editFileModal" class="modal">
    <form id="editFileForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <h2>Edit File</h2>
      <label>Title</label>
      <input type="text" name="title" id="editFileTitle">
      <label>Description</label>
      <textarea name="description" id="editFileDescription"></textarea>
      <input type="file" name="file">
      <button type="submit">Update</button>
      <button type="button" onclick="closeModal('editFileModal')">Cancel</button>
    </form>
  </div>

 <div id="addLessonModal" class="modal">
  <form id="addLessonForm" action="{% url 'add_lesson' %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <h2>Add Lesson</h2>

    <!-- Your Django form (keeps id_video, id_image, id_files, id_attachments) -->
    {{ lesson_form.as_p }}

    <!-- Recording UI -->
    <div class="rec-grid" style="gap:16px; margin-top: 8px;">
     <!-- Pretty upload blocks (click = open inputs) -->
<div class="upload-block" onclick="document.getElementById('id_image').click()">
  <div class="ub-icon">üñºÔ∏è</div>
  <div>
    <div class="ub-title">Image</div>
    <div class="ub-sub">Drop or click to select an image</div>
  </div>
</div>

<div class="upload-block" onclick="document.getElementById('id_attachments').click()">
  <div class="ub-icon">üìé</div>
  <div>
    <div class="ub-title">Upload file(s)</div>
    <div class="ub-sub">You can select multiple files</div>
  </div>
</div>

    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-dark">Save</button>
      <button type="button" onclick="closeModal('addLessonModal')" class="btn btn-light">Cancel</button>
    </div>
  </form>
</div>
  <div id="editLessonModal" class="modal">
    <form id="editLessonForm" method="post">
      {% csrf_token %}
      <h2>Edit Lesson</h2>
      <label>Title</label>
      <input type="text" name="title" id="editLessonTitle">
      <label>Subtitle</label>
      <input type="text" name="subtitle" id="editLessonSubtitle">
      <label>Message</label>
      <textarea name="message" id="editLessonMessage"></textarea>
      <button type="submit">Update</button>
      <button type="button" onclick="closeModal('editLessonModal')">Cancel</button>
    </form>
  </div>

  <script>
    const tabs = document.querySelectorAll(".tab");
    const contents = document.querySelectorAll(".tab-content");
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      contents.forEach(c => c.classList.remove("active"));
      t.classList.add("active");
      document.getElementById(t.dataset.tab).classList.add("active");
    }));

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function openEditFileModal(id, title, desc) {
      document.getElementById("editFileForm").action = `/edit-file/${id}/`;
      document.getElementById("editFileTitle").value = title;
      document.getElementById("editFileDescription").value = desc;
      openModal('editFileModal');
    }

    function openEditLessonModal(id, title, subtitle, msg) {
      document.getElementById("editLessonForm").action = `/edit-lesson/${id}/`;
      document.getElementById("editLessonTitle").value = title;
      document.getElementById("editLessonSubtitle").value = subtitle;
      document.getElementById("editLessonMessage").value = msg;
      openModal('editLessonModal');
    }
  </script>
  <script>
  // Utilities
  const fmt = ms => {
    const s = Math.floor(ms/1000);
    return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  };
  const toFile = (blob, base) => {
    const t = blob.type || 'application/octet-stream';
    let ext = 'bin';
    if (t.includes('webm')) ext = 'webm';
    else if (t.includes('mp4')) ext = 'mp4';
    else if (t.includes('ogg')) ext = 'ogg';
    else if (t.includes('mpeg')) ext = 'mpg';
    const name = `${base}_${Date.now()}.${ext}`;
    return new File([blob], name, { type: t });
  };
  const setFileInput = (input, file) => {
    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
  };
  const pickMime = (types) => {
    if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) return '';
    for (const t of types) if (MediaRecorder.isTypeSupported(t)) return t;
    return '';
  };

  // Scope everything to the Add Lesson modal
  (function () {
    const modal = document.getElementById('addLessonModal');
    if (!modal) return;

    // Grab form inputs (rendered by Django)
    const videoInput = document.getElementById('id_video');          // Lesson.video
    const attInput   = document.getElementById('id_attachments');    // LessonForm.attachments (MultiFileInput)

    // Timers
    let vTick=null, aTick=null;

    // -------- Video recording --------
    const camStart = modal.querySelector('#lr_cam_start');
    const vidRec   = modal.querySelector('#lr_vid_rec');
    const vidStop  = modal.querySelector('#lr_vid_stop');
    const vTimer   = modal.querySelector('#lr_vid_timer');
    const vLive    = modal.querySelector('#lr_video_live');
    const vPrev    = modal.querySelector('#lr_video_prev');

    let vStream=null, vRecorder=null, vChunks=[], vStart=null;

    camStart?.addEventListener('click', async () => {
      try {
        vStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        vLive.srcObject = vStream;
        vidRec.disabled = false;
        camStart.disabled = true;
      } catch (e) {
        alert('Camera/mic not available or permission denied.');
        console.error(e);
      }
    });

    vidRec?.addEventListener('click', () => {
      try {
        vChunks = [];
        const mime = pickMime(['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/mp4;codecs=h264,aac','video/webm']);
        vRecorder = new MediaRecorder(vStream, mime ? { mimeType: mime } : {});
        vRecorder.ondataavailable = e => { if (e.data?.size) vChunks.push(e.data); };
        vRecorder.onstop = () => {
          const blob = new Blob(vChunks, { type: vRecorder.mimeType || 'video/webm' });
          const file = toFile(blob, 'lesson_video');
          if (videoInput) setFileInput(videoInput, file);

          vPrev.src = URL.createObjectURL(blob);
          vPrev.classList.remove('d-none');
          vLive.classList.add('d-none');
        };
        vRecorder.start();
        vStart = Date.now();
        vTick = setInterval(()=> vTimer.textContent = fmt(Date.now()-vStart), 250);
        vidRec.disabled = true; vidStop.disabled = false;
      } catch (e) {
        alert('Video recording not supported in this browser.');
        console.error(e);
      }
    });

    vidStop?.addEventListener('click', () => {
      try {
        clearInterval(vTick);
        vidStop.disabled = true;
        if (vRecorder && vRecorder.state !== 'inactive') vRecorder.stop();
        if (vStream) vStream.getTracks().forEach(t => t.stop());
      } catch (e) { console.error(e); }
    });

    // -------- Audio recording --------
    const audStart = modal.querySelector('#lr_aud_start');
    const audStop  = modal.querySelector('#lr_aud_stop');
    const aTimer   = modal.querySelector('#lr_aud_timer');
    const aPlayer  = modal.querySelector('#lr_audio_player');

    let aStream=null, aRecorder=null, aChunks=[], aStart=null;

    audStart?.addEventListener('click', async () => {
      try {
        aStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        aChunks = [];
        const mime = pickMime(['audio/webm;codecs=opus','audio/mp4;codecs=aac','audio/ogg;codecs=opus','audio/webm']);
        aRecorder = new MediaRecorder(aStream, mime ? { mimeType: mime } : {});
        aRecorder.ondataavailable = e => { if (e.data?.size) aChunks.push(e.data); };
        aRecorder.onstop = () => {
          const blob = new Blob(aChunks, { type: aRecorder.mimeType || 'audio/webm' });
          const file = toFile(blob, 'lesson_audio');
          if (attInput) setFileInput(attInput, file);  // attachments

          aPlayer.src = URL.createObjectURL(blob);
          aPlayer.classList.remove('d-none');
        };
        aRecorder.start();
        aStart = Date.now();
        aTick = setInterval(()=> aTimer.textContent = fmt(Date.now()-aStart), 250);
        audStart.disabled = true; audStop.disabled = false;
      } catch (e) {
        alert('Mic not available or permission denied.');
        console.error(e);
      }
    });

    audStop?.addEventListener('click', () => {
      try {
        clearInterval(aTick);
        audStop.disabled = true;
        if (aRecorder && aRecorder.state !== 'inactive') aRecorder.stop();
        if (aStream) aStream.getTracks().forEach(t => t.stop());
        audStart.disabled = false;
      } catch (e) { console.error(e); }
    });
  })();
</script>
{% endblock %}
