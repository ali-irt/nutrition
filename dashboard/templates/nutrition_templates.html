{% extends "base.html" %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<!-- Header -->
<section class="bg-black text-white py-8 px-6">
  <h1 class="text-4xl font-bold">Nutrition</h1>
  <div class="flex space-x-8 mt-4 text-gray-300">
    <a href="{% url 'nutrition_recipes' %}" class="hover:text-white {% if active_tab == 'recipes' %}border-b-2 border-white text-white{% endif %}">Recipes</a>
    <a href="{% url 'nutrition' %}" class="hover:text-white {% if active_tab == 'ingredients' %}border-b-2 border-white text-white{% endif %}">Ingredients</a>
    <a href="{% url 'nutrition_templates' %}" class="hover:text-white {% if active_tab == 'templates' %}border-b-2 border-white text-white{% endif %}">Templates</a>
  </div>
</section>

<!-- Main -->
<main class="bg-gray-50 px-8 py-12 min-h-screen">
  <!-- Topbar -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
    <p class="text-sm font-semibold">Showing {{ templates|length }} templates</p>
    <div class="flex items-center gap-2">
      <div class="relative">
        <input type="text" placeholder="Search" class="pl-9 pr-3 py-2 border rounded-lg text-sm bg-white" />
        <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-4.3-4.3M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/>
        </svg>
      </div>
      
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white rounded-lg shadow-sm overflow-hidden">
    <table class="w-full text-left">
      <thead class="bg-gray-50 border-b">
        <tr class="text-sm">
          <th class="py-3 px-4 font-semibold">Name</th>
          <th class="py-3 px-4 font-semibold">Language</th>
          <th class="py-3 px-4 font-semibold">Protein</th>
          <th class="py-3 px-4 font-semibold">Carbohydrates</th>
          <th class="py-3 px-4 font-semibold">Fat</th>
          <th class="py-3 px-4 font-semibold">Calories</th>
        </tr>
      </thead>
      <tbody id="templatesBody">
        {% if templates %}
          {% for t in templates %}
          <tr class="border-b hover:bg-gray-50">
            <td class="py-3 px-4">{{ t.name }}</td>
            <td class="py-3 px-4 text-sm">{{ t.language|default:"—" }}</td>
            <td class="py-3 px-4 text-sm">
              {% if t.protein %}{{ t.protein }}g{% else %}—{% endif %}
            </td>
            <td class="py-3 px-4 text-sm">
              {% if t.carbs %}{{ t.carbs }}g{% else %}—{% endif %}
            </td>
            <td class="py-3 px-4 text-sm">
              {% if t.fats %}{{ t.fats }}g{% else %}—{% endif %}
            </td>
            <td class="py-3 px-4 text-sm">{{ t.target_calories}}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr id="templatesEmptyRow">
            <td colspan="6" class="py-16 text-center">
              <div class="mx-auto w-10 h-10 flex items-center justify-center bg-black text-white rounded-full mb-4">?</div>
              <div class="font-semibold">No templates yet</div>
              <div class="text-sm text-gray-500">Go ahead — save any of your clients’ nutrition plans as a template</div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</main>


<script>
  // Open/close modal
  document.addEventListener('click', (e) => {
    const opener = e.target.closest('[data-modal-open]');
    if (opener) document.querySelector(opener.getAttribute('data-modal-open'))?.classList.remove('hidden');
    const closer = e.target.closest('[data-modal-close]');
    if (closer) document.querySelector(closer.getAttribute('data-modal-close'))?.classList.add('hidden');
    if (e.target.classList?.contains('modal-overlay')) e.target.classList.add('hidden');
  });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden')); });

  // Auto-calc kcal
  const tplP = document.getElementById('tplP');
  const tplC = document.getElementById('tplC');
  const tplF = document.getElementById('tplF');
  const tplK = document.getElementById('tplKcal');
  function recalcTplKcal() {
    const p = parseFloat(tplP.value || 0), c = parseFloat(tplC.value || 0), f = parseFloat(tplF.value || 0);
    tplK.value = Math.max(0, Math.round(p*4 + c*4 + f*9));
  }
  [tplP, tplC, tplF].forEach(i => i.addEventListener('input', recalcTplKcal));

  // Submit via AJAX
  document.addEventListener('submit', async (e) => {
    const form = e.target.closest('#templateForm');
    if (!form) return;
    e.preventDefault();

    // sync calories
    recalcTplKcal();

    const btn = document.getElementById('templateSubmitBtn');
    const errBox = document.getElementById('templateErrors');
    errBox.classList.add('hidden'); errBox.innerHTML='';
    btn.disabled = true; btn.textContent = 'Saving...';

    try {
      const res = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value },
        body: new FormData(form)
      });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        const errs = data.errors || {};
        errBox.innerHTML = Object.entries(errs).map(([f, m]) => `<div><strong>${f}</strong>: ${Array.isArray(m)?m.join(', '):m}</div>`).join('') || 'Failed to save.';
        errBox.classList.remove('hidden');
        return;
      }

      // Remove empty state and prepend row
      document.getElementById('templatesEmptyRow')?.remove();
      const tb = document.getElementById('templatesBody');
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-gray-50';
      tr.innerHTML = `
        <td class="py-3 px-4">${data.row.name}</td>
        <td class="py-3 px-4 text-sm">${data.row.language || '—'}</td>
        <td class="py-3 px-4 text-sm">${data.row.protein ?? '—'}${data.row.protein !== undefined ? 'g' : ''}</td>
        <td class="py-3 px-4 text-sm">${data.row.carbs ?? '—'}${data.row.carbs !== undefined ? 'g' : ''}</td>
        <td class="py-3 px-4 text-sm">${data.row.fats ?? '—'}${data.row.fats !== undefined ? 'g' : ''}</td>
        <td class="py-3 px-4 text-sm">${data.row.target_calories ?? data.row.calories ?? '—'}</td>
      `;
      tb?.prepend(tr);

      form.reset();
      document.getElementById('templateModal')?.classList.add('hidden');
    } catch (err) {
      errBox.textContent = 'Unexpected error. Please try again.';
      errBox.classList.remove('hidden');
    } finally {
      btn.disabled = false; btn.textContent = 'Create';
    }
  });
</script>
{% endblock %}