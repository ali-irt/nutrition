{% extends "base.html" %}
{% load static %}
{% block content %}
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js for tab switching -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    .bg {
      margin-top: 30px;
    }
    .tab {
      display: block;
    }
  </style>
</head>
<body class="text-white min-h-screen" x-data="{ tab: 'overview', deliveryFilter: 'all', paymentFilter: 'all', showMenu: null }">

  <!-- Page Title & Tabs -->
  <div style="padding-left: 2in;" class="bg-black px-6pb-6">
    <h1 class="text-4xl font-bold mb-6">Meals</h1>
    <div class="flex gap-6 text-sm border-b border-gray-800">
      <button @click="tab = 'overview'" :class="tab === 'overview' ? 'text-white pb-3 border-b-2 border-white font-semibold' : 'text-gray-400 pb-3 hover:text-white'">Overview</button>
      <button @click="tab = 'orders'" :class="tab === 'orders' ? 'text-white pb-3 border-b-2 border-white font-semibold' : 'text-gray-400 pb-3 hover:text-white'">Orders</button>
      <button @click="tab = 'clients'" :class="tab === 'clients' ? 'text-white pb-3 border-b-2 border-white font-semibold' : 'text-gray-400 pb-3 hover:text-white'">Clients</button>
      <button @click="tab = 'inventory'" :class="tab === 'inventory' ? 'text-white pb-3 border-b-2 border-white font-semibold' : 'text-gray-400 pb-3 hover:text-white'">Inventory</button>
      <button @click="tab = 'delivery'" :class="tab === 'delivery' ? 'text-white pb-3 border-b-2 border-white font-semibold' : 'text-gray-400 pb-3 hover:text-white'">Delivery</button>
      <button @click="tab = 'payments'" :class="tab === 'payments' ? 'text-white pb-3 border-b-2 border-white font-semibold' : 'text-gray-400 pb-3 hover:text-white'">Payments</button>
    </div>
  </div>

  <main class="px-6 pb-8">

    <!-- 🔹 Overview Tab -->
    <section x-show="tab === 'overview'" x-transition>
  <div style="margin-top:20px ;" class="black rounded-3xl p-8">
   <div class="flex items-center justify-around">
          <div class="text-center">       
                 <div class="text-4xl font-bold">{{ stats.total_meals }}</div>
  <div class="text-lg font-semibold">Total Meals</div>

        </div>
        <div class="text-center">       
                 <div class="text-4xl font-bold">{{ stats.avg_calories }}</div>
                   <div class="text-lg font-semibold">Averga Calories</div>


        </div>
         
        <div class="text-center">       
               <p class="text-gray-400 text-sm mb-2">Vegan Meals</p>
                 <div class="text-4xl font-bold">{{ stats.vegan_count }}</div>
  <div class="text-lg font-semibold">Vegan Meals</div>

        </div>
      <div class="text-center">       
                 <div class="text-4xl font-bold">{{ stats.vegetarian_count }}</div>
  <div class="text-lg font-semibold">Vegetarian Meals</div>

        </div>
       
      </div>
      </div>

      <div class="bg-white text-black rounded-2xl shadow-lg overflow-hidden">
        <div class="p-6">
          <h2 class="text-xl font-bold mb-4">All Meals</h2>
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-gray-100 text-left">
                <th class="px-4 py-3 rounded-l-lg font-semibold">Image</th>
                <th class="px-4 py-3 font-semibold">Name</th>
                <th class="px-4 py-3 font-semibold">Type</th>
                <th class="px-4 py-3 font-semibold">Calories</th>
                <th class="px-4 py-3 font-semibold">Difficulty</th>
                <th class="px-4 py-3 rounded-r-lg font-semibold">Prep Time</th>
              </tr>
            </thead>
            <tbody>
              {% for meal in meals %}
              <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="px-4 py-4">
                  {% if meal.image %}
                  <img src="{{ meal.image.url }}" class="w-12 h-12 rounded-lg object-cover">
                  {% else %}
                  <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 text-xs">N/A</div>
                  {% endif %}
                </td>
                <td class="px-4 py-4 font-semibold">{{ meal.name }}</td>
                <td class="px-4 py-4 capitalize">{{ meal.get_meal_type_display }}</td>
                <td class="px-4 py-4">{{ meal.calories }} kcal</td>
                <td class="px-4 py-4">{{ meal.get_difficulty_display }}</td>
                <td class="px-4 py-4">{{ meal.preparation_time }} min</td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No meals found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 🔹 Orders Tab -->
    <section x-show="tab === 'orders'" x-transition>
        <div style="margin-top:20px ;" class="black rounded-3xl p-8">
        <div class="flex items-center justify-around">
          <div class="text-center">
            <div class="text-4xl font-bold">{{ order_stats.total }}</div>
            <div class="text-sm text-gray-400 mt-2">Total Orders</div>
          </div>
          <div class="text-center">
            <div class="text-4xl font-bold text-yellow-400">{{ order_stats.pending }}</div>
            <div class="text-sm text-gray-400 mt-2">Meals to prepare</div>
          </div>
         
          <div class="text-center">
            <div class="text-4xl font-bold text-green-400">{{ order_stats.delivered }}</div>
            <div class="text-sm text-gray-400 mt-2">Delivered</div>
          </div>
           <div class="text-center">
            <div class="text-4xl font-bold text-blue-400">{{ order_stats.in_progress }}</div>
            <div class="text-sm text-gray-400 mt-2">In Progress</div>
          </div>
        </div>
      </div>
      
      <div class="bg-white text-black rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4">Orders List</h2>
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-100 text-left">
              <th class="px-4 py-3 font-semibold">Client</th>
              <th class="px-4 py-3 font-semibold">Location</th>
                            <th class="px-4 py-3 rounded-l-lg font-semibold">Order ID</th>

              <th class="px-4 py-3 font-semibold">Status</th>
             </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="px-4 py-4">{{ order.client.username }}</td>
              <td class="px-4 py-4">{{ order.client.location }}</td>
              <td class="px-4 py-4 font-medium">#{{ order.id }}</td>
               <td class="px-4 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-semibold
                  {% if order.status == 'delivered' %}bg-green-100 text-green-700
                  {% elif order.status == 'in_progress' %}bg-blue-100 text-blue-700
                  {% elif order.status == 'pending' %}bg-yellow-100 text-yellow-700
                  {% else %}bg-gray-100 text-gray-700{% endif %}">
                  {{ order.get_status_display }}
                </span>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No orders found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  <!-- 🔹 Clients Tab -->
<section x-show="tab === 'clients'" x-transition>

  <!-- Stats Section -->
  <div class="black rounded-3xl p-8 mt-5">
    <div class="flex flex-wrap items-center justify-around gap-6 text-center">
      <div>
        <div class="text-4xl font-bold text-white">{{ client_stats.total }}</div>
        <div class="text-sm text-gray-400 mt-2">Total Clients</div>
      </div>
      <div>
        <div class="text-4xl font-bold text-yellow-400">{{ client_stats.active }}</div>
        <div class="text-sm text-gray-400 mt-2">Active</div>
      </div>
      <div>
        <div class="text-4xl font-bold text-green-400">{{ client_stats.paused }}</div>
        <div class="text-sm text-gray-400 mt-2">Paused Clients</div>
      </div>
    </div>
  </div>

  <!-- Add Client Button -->
<div class="mt-4" style="text-align: right;">
  <button
    style="background-color: #000000;"
    class="btn btn-dark rounded-pill px-4 py-2  align-items-center"
    data-bs-toggle="modal"
    data-bs-target="#addClientModal"
  >
    <i class="bi bi-plus-lg me-2"></i> Add Client
  </button>
</div>


  <!-- Clients Table -->
  <div class="bg-white rounded-4 shadow p-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="fw-bold mb-1">Client List</h2>
        <p class="text-muted mb-0">Overview of all clients and statuses</p>
      </div>
    </div>

    <div class="table-container full-width-table">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Goal</th>
            <th>Plan Type</th>
            <th>Join Date</th>
            <th>End Date</th>
            <th>Status</th>
            <th>Dietitian</th>
            <th>Progress</th>
          </tr>
        </thead>
        <tbody>
          {% for client in clients %}
          <tr>
            <td>{{ client.get_full_name|default:client.username }}</td>
            <td>{{ client.profile.goal }}</td>
            <td>{{ client.profile.plan}}</td>
            <td>{{ client.profile.start_date|date:"M d, Y" }}</td>
            <td>{{ client.profile.end_date|date:"M d, Y" }}</td>
            <td>
              {% if client.is_active %}
                <span class="badge bg-success rounded-pill">Active</span>
              {% else %}
                <span class="badge bg-danger rounded-pill">Inactive</span>
              {% endif %}
            </td>
            <td>{{ client.profile.dietition_assigned }}</td>
            <td>{{ client.profile.progress }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">No clients found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

 <!-- Add Client Modal -->
<!-- SIMPLE PREMIUM ADD CLIENT MODAL -->
<div class="modal fade premium-modal" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header premium-modal-header">
        <h5 class="modal-title">
          <i class="bi bi-person-plus-fill"></i>
          Add New Client
        </h5>
        <button type="button" class="btn-close premium-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'add_client' %}">
        {% csrf_token %}
        <div class="modal-body premium-modal-body">
          {{ user_form.as_p }}
          {{ profile_form.as_p }}
        </div>
        <div class="modal-footer premium-modal-footer">
          <button type="button" class="premium-btn premium-btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="premium-btn premium-btn-dark">
            <i class="bi bi-check-circle me-2"></i>Save Client
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- SIMPLE PREMIUM FORM STYLING -->
<style>
  /* Style Django form fields to match premium theme */
  .premium-modal-body input[type="text"],
  .premium-modal-body input[type="email"],
  .premium-modal-body input[type="password"],
  .premium-modal-body input[type="tel"],
  .premium-modal-body textarea,
  .premium-modal-body select {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 12px 16px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    width: 100%;
  }

  .premium-modal-body input:focus,
  .premium-modal-body textarea:focus,
  .premium-modal-body select:focus {
    border-color: #f5f5f5;
    box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05);
    outline: none;
  }

  /* Style labels */
  .premium-modal-body label {
    color: #cfd6df;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 6px;
    display: block;
  }

  /* Remove default paragraph margins */
  .premium-modal-body p {
    margin-bottom: 16px;
    color: black;
  }

  /* Style help text */
  .premium-modal-body .helptext {
    display: block;
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
  }

  /* Style error messages */
  .premium-modal-body .errorlist {
    list-style: none;
    padding: 0;
    margin: 6px 0 0 0;
  }

  .premium-modal-body .errorlist li {
    color: #dc2626;
    font-size: 0.75rem;
    font-weight: 500;
  }
</style>

</section>

<!-- COMPLETE INVENTORY SECTION - REPLACE YOUR ENTIRE INVENTORY SECTION WITH THIS -->

<!-- 🔹 Inventory Tab -->
<section x-show="tab === 'inventory'" x-transition>
  <div style="margin-top:20px;" class="black rounded-3xl p-8">
    <div class="flex items-center justify-around">
      <div class="text-center">
        <div class="text-4xl font-bold text-white">{{ inventory_stats.total_ingredients }}</div>
        <div class="text-sm text-gray-400 mt-2">Total Ingredients</div>
      </div>
      <div class="text-center">
        <div class="text-4xl font-bold text-yellow-400">{{ inventory_stats.low_stock }}</div>
        <div class="text-sm text-gray-400 mt-2">Low Stock</div>
      </div>
      <div class="text-center">
        <div class="text-4xl font-bold text-green-400">{{ inventory_stats.reorder_alerts }}</div>
        <div class="text-sm text-gray-400 mt-2">Reorder Alerts</div>
      </div>
    </div>
  </div>
   <!-- Add Ingredient Button -->
  <div class="flex justify-end mt-4">
    <button 
      style="background-color: #000000;" 
      class="btn btn-dark rounded-pill px-4 py-2 d-flex align-items-center"
      data-bs-toggle="modal" 
      data-bs-target="#addInventoryModal">
      <i class="bi bi-plus-lg me-2"></i> Add Ingredient
    </button>
  </div>
  <div class="bg-white rounded-4 shadow p-4 mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="fw-bold mb-1">Inventory & Ingredients</h2>
        <p class="text-muted mb-0">Track stock levels and manage ingredients</p>
      </div>
     
    </div>

    <!-- Inventory Table -->
    <div class="table-responsive">
      <table class="table align-middle table-hover" id="inventoryTable">
        <thead class="table-dark">
          <tr>
            <th>Ingredient</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Forecast (Weekly)</th>
            <th>Reorder Level</th>
            <th>Supplier</th>
            <th>Price (PKR)</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in inventory %}
          <tr>
            <td>{{ item.ingredient_name }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.unit }}</td>
            <td>{{ item.low_stock_alert }}</td>
            <td>{{ item.reorder_level }}</td>
            <td>{{ item.supplier }}</td>
            <td>{{ item.price }}</td>
            <td class="text-center">
              <button class="btn btn-outline-dark btn-sm me-2" data-bs-toggle="modal" data-bs-target="#editInventoryModal{{ item.id }}">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteInventoryModal{{ item.id }}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-5 text-muted">No inventory items found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- ================================ -->
<!-- PREMIUM MODAL STYLES - ADD ONCE -->
<!-- ================================ -->
<style>
  /* Center Modal & Background Blur */
  .modal-backdrop.show {
    background: rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(60px);
  }

  .premium-modal .modal-dialog {
    max-width: 500px;
    width: 90%;
    margin: auto;
    background-color: rgb(24, 8, 8);
  }

  /* Make modal truly centered and responsive */
  @media (max-width: 768px) {
    .premium-modal .modal-dialog {
      max-width: 90%;
    }
    .premium-modal .modal-body {
      padding: 1.5rem !important;
    }
  }
  @media (max-width: 1200px) {
    .premium-modal .modal-dialog {
      max-width: 90%;
      max-height: 60%;
    }
    .premium-modal .modal-body {
      padding: 1.5rem !important;
    }
  }

  /* Shrink spacing for compact look */
  .premium-modal .modal-content {
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    animation: modalPop 0.3s ease-out;
  }

  @keyframes modalPop {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
 
   
</style>

<!-- ================================ -->
<!-- ➕ ADD INVENTORY MODAL (PREMIUM) -->
<!-- ================================ -->
<div class="modal fade premium-modal" id="addInventoryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header premium-modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i>
          Add New Ingredient
        </h5>
        <button type="button" class="btn-close premium-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'add_inventory' %}">
        {% csrf_token %}
        <div class="modal-body premium-modal-body">
          <div class="premium-input-group">
            <label class="premium-form-label">Ingredient Name</label>
            <input type="text" class="form-control premium-form-control" name="ingredient_name" placeholder="Enter ingredient name" required>
          </div>
          
          <div class="row">
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Quantity</label>
              <input type="number" step="0.01" class="form-control premium-form-control" name="quantity" placeholder="0.00" required>
            </div>
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Unit</label>
              <input type="text" class="form-control premium-form-control" name="unit" placeholder="kg, lbs, etc." required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Weekly Forecast</label>
              <input type="number" step="0.01" class="form-control premium-form-control" name="low_stock_alert" placeholder="0.00">
            </div>
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Reorder Level</label>
              <input type="number" step="0.01" class="form-control premium-form-control" name="reorder_level" placeholder="0.00" required>
            </div>
          </div>
          
          <div class="premium-input-group">
            <label class="premium-form-label">Supplier</label>
            <input type="text" class="form-control premium-form-control" name="supplier" placeholder="Supplier name">
          </div>
          
          <div class="premium-input-group">
            <label class="premium-form-label">Price (PKR)</label>
            <input type="number" step="0.01" class="form-control premium-form-control" name="price" placeholder="0.00" required>
          </div>
        </div>
        <div class="modal-footer premium-modal-footer">
          <button type="button" class="premium-btn premium-btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="premium-btn premium-btn-dark">
            <i class="bi bi-check-circle"></i>Add Ingredient
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================================ -->
<!-- 📝 EDIT INVENTORY MODALS (PREMIUM) -->
<!-- ================================ -->
{% for item in inventory %}
<div class="modal fade premium-modal" id="editInventoryModal{{ item.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header premium-modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square"></i>
          Edit Ingredient
        </h5>
        <button type="button" class="btn-close premium-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'edit_inventory' item.id %}">
        {% csrf_token %}
        <div class="modal-body premium-modal-body">
          <div class="premium-input-group">
            <label class="premium-form-label">Ingredient Name</label>
            <input type="text" class="form-control premium-form-control" name="ingredient_name" value="{{ item.ingredient_name }}" required>
          </div>
          
          <div class="row">
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Quantity</label>
              <input type="number" step="0.01" class="form-control premium-form-control" name="quantity" value="{{ item.quantity }}" required>
            </div>
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Unit</label>
              <input type="text" class="form-control premium-form-control" name="unit" value="{{ item.unit }}" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Weekly Forecast</label>
              <input type="number" step="0.01" class="form-control premium-form-control" name="low_stock_alert" value="{{ item.low_stock_alert }}">
            </div>
            <div class="col-md-6 premium-input-group">
              <label class="premium-form-label">Reorder Level</label>
              <input type="number" step="0.01" class="form-control premium-form-control" name="reorder_level" value="{{ item.reorder_level }}" required>
            </div>
          </div>
          
          <div class="premium-input-group">
            <label class="premium-form-label">Supplier</label>
            <input type="text" class="form-control premium-form-control" name="supplier" value="{{ item.supplier }}">
          </div>
          
          <div class="premium-input-group">
            <label class="premium-form-label">Price (PKR)</label>
            <input type="number" step="0.01" class="form-control premium-form-control" name="price" value="{{ item.price }}" required>
          </div>
        </div>
        <div class="modal-footer premium-modal-footer">
          <button type="button" class="premium-btn premium-btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="premium-btn premium-btn-dark">
            <i class="bi bi-save"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================================ -->
<!-- ❌ DELETE CONFIRMATION MODAL (PREMIUM) -->
<!-- ================================ -->
<div class="modal fade premium-modal" id="deleteInventoryModal{{ item.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header premium-modal-header premium-modal-header-danger">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle"></i>
          Confirm Deletion
        </h5>
        <button type="button" class="btn-close premium-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body premium-modal-body">
        <div class="text-center py-3">
          <div class="mb-4">
            <i class="bi bi-trash delete-icon-animate" style="font-size: 3rem; color: #dc2626;"></i>
          </div>
          <h4 class="mb-3" style="color: #1f2937; font-weight: 600;">Delete {{ item.ingredient_name }}?</h4>
          <p class="text-muted mb-0">This action cannot be undone. All data associated with this ingredient will be permanently removed from the system.</p>
        </div>
      </div>
      <div class="modal-footer premium-modal-footer">
        <button type="button" class="premium-btn premium-btn-light" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i>Cancel
        </button>
        <form method="post" action="{% url 'delete_inventory' item.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="premium-btn premium-btn-danger">
            <i class="bi bi-trash"></i>Delete Permanently
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}
</section>
    <!-- 🔹 Delivery Tab -->
    <section x-show="tab === 'delivery'" x-transition>
      <!-- Stats Cards -->
      <div class="mb-8" style="margin-top: 20px;">
        <div class="black rounded-3xl p-8">
          <div class="flex items-center justify-around">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ delivery_stats.total }}</div>
                <div class="text-sm text-gray-400">Total Deliveries</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ delivery_stats.pending }}</div>
                <div class="text-sm text-gray-400">Pending</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ delivery_stats.out_for_delivery }}</div>
                <div class="text-sm text-gray-400">Out for Delivery</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ delivery_stats.delivered }}</div>
                <div class="text-sm text-gray-400">Delivered</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ delivery_stats.failed }}</div>
                <div class="text-sm text-gray-400">Failed</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery List -->
      <div class="bg-white text-black rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="text-sm text-gray-600">Showing {{ deliveries.count }} result{{ deliveries.count|pluralize }}</div>
        </div>

        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Delivery List</h2>
        </div>

        <table class="w-full">
          <thead>
            <tr class="bg-gray-100 text-left">
              <th class="px-4 py-3 rounded-l-lg text-sm font-semibold">Id#</th>
              <th class="px-4 py-3 text-sm font-semibold">Date & Time</th>
              <th class="px-4 py-3 text-sm font-semibold">Rider</th>
              <th class="px-4 py-3 text-sm font-semibold">Address</th>
              <th class="px-4 py-3 text-sm font-semibold">Status</th>
              <th class="px-4 py-3 rounded-r-lg text-sm font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for delivery in deliveries %}
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="px-4 py-4 text-sm font-medium">#D{{ delivery.id }}</td>
              <td class="px-4 py-4 text-sm">{{ delivery.delivery_time|date:"M d, g:iA" }}</td>
              <td class="px-4 py-4 text-sm">{{ delivery.rider_name|default:"Not Assigned" }}</td>
              <td class="px-4 py-4 text-sm">{{ delivery.address }}</td>
              <td class="px-4 py-4 text-sm">
                <span class="px-3 py-1 rounded-full text-xs font-semibold
                  {% if delivery.status == 'delivered' %}bg-green-100 text-green-700
                  {% elif delivery.status == 'out_for_delivery' %}bg-blue-100 text-blue-700
                  {% elif delivery.status == 'pending' %}bg-yellow-100 text-yellow-700
                  {% elif delivery.status == 'failed' %}bg-red-100 text-red-700
                  {% else %}bg-gray-100 text-gray-700{% endif %}">
                  {{ delivery.get_status_display }}
                </span>
              </td>
              <td class="px-4 py-4 text-sm">
                <div class="relative" x-data="{ open: false }">
                  <button @click="open = !open" class="p-1 hover:bg-gray-200 rounded">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                    </svg>
                  </button>
                  <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-10 w-24">
                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100">View</button>
                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100">Edit</button>
                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100 text-red-600">Cancel</button>
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No deliveries found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- 🔹 Payments Tab -->
    <section x-show="tab === 'payments'" x-transition>
      <!-- Stats Cards -->
      <div class="mb-8" style="margin-top: 20px;">
        <div class="black rounded-3xl p-8">
          <div class="flex items-center justify-around">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ payment_stats.total }}</div>
                <div class="text-sm text-gray-400">Total Payments</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ payment_stats.paid }}</div>
                <div class="text-sm text-gray-400">Paid</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">PKR {{ payment_stats.revenue|floatformat:0 }}</div>
                <div class="text-sm text-gray-400">Total Revenue</div>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="text-3xl font-bold">{{ payment_stats.pending }}</div>
                <div class="text-sm text-gray-400">Pending Payments</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payments List -->
      <div class="bg-white text-black rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="text-sm text-gray-600">Showing {{ payments.count }} result{{ payments.count|pluralize }}</div>
        </div>

        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Payments</h2>
        </div>

        <table class="w-full">
          <thead>
            <tr class="bg-gray-100 text-left">
              <th class="px-4 py-3 rounded-l-lg text-sm font-semibold">Id#</th>
              <th class="px-4 py-3 text-sm font-semibold">Client</th>
              <th class="px-4 py-3 text-sm font-semibold">Plan Type</th>
              <th class="px-4 py-3 text-sm font-semibold">Amount</th>
              <th class="px-4 py-3 text-sm font-semibold">Payment Method</th>
              <th class="px-4 py-3 rounded-r-lg text-sm font-semibold">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="px-4 py-4 text-sm font-medium">{{ payment.id|stringformat:"03d" }}</td>
              <td class="px-4 py-4 text-sm">{{ payment.client.username }}</td>
              <td class="px-4 py-4 text-sm">{{ payment.plan_type|default:"Basic Plan" }}</td>
              <td class="px-4 py-4 text-sm">{{ payment.amount|floatformat:0 }} PKR</td>
              <td class="px-4 py-4 text-sm">{{ payment.payment_method|default:"Credit Card" }}</td>
              <td class="px-4 py-4 text-sm">
                <div class="flex items-center justify-between">
                  <span class="px-3 py-1 rounded-full text-xs font-semibold
                    {% if payment.status == 'paid' %}bg-green-100 text-green-700
                    {% elif payment.status == 'pending' %}bg-yellow-100 text-yellow-700
                    {% elif payment.status == 'failed' %}bg-red-100 text-red-700
                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                    {{ payment.get_status_display }}
                  </span>
                  <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="p-1 hover:bg-gray-200 rounded">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                      </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-10 w-32">
<a href="{% url 'download_payments' %}" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
  Download CSV
</a>                    <button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-100">Refund History</button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">No payments found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

<!-- Add jsPDF libraries in your base.html or in this template -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- Add Bootstrap Icons if not already included -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script>

function getInventoryData() {
  const table = document.getElementById('inventoryTable');
  const headers = [];
  const rows = [];

  table.querySelectorAll('thead th').forEach((th, index) => {
    // Skip the Actions column
    if (index < 7) {
      headers.push(th.textContent.trim());
    }
  });

  table.querySelectorAll('tbody tr').forEach(tr => {
    const row = [];
    tr.querySelectorAll('td').forEach((td, index) => {
      // Skip the Actions column
      if (index < 7) {
        row.push(td.textContent.trim());
      }
    });
    if (row.length > 0) rows.push(row);
  });

  return { headers, rows };
}

function calculateInventoryStats() {
  const { rows } = getInventoryData();
  let totalValue = 0;
  let lowStockCount = 0;
  const suppliers = new Set();

  rows.forEach(row => {
    const stock = parseFloat(row[1]) || 0;
    const reorderLevel = parseFloat(row[4]) || 0;
    const price = parseFloat(row[6]) || 0;
    const supplier = row[5];

    totalValue += price;
    if (stock < reorderLevel) lowStockCount++;
    if (supplier && supplier !== 'N/A') suppliers.add(supplier);
  });

  return {
    totalItems: rows.length,
    totalValue: totalValue,
    lowStock: lowStockCount,
    suppliers: suppliers.size
  };
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { headers, rows } = getInventoryData();
  const stats = calculateInventoryStats();
  const today = new Date().toLocaleDateString('en-GB', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  });

  // Professional Header
  doc.setFillColor(17, 24, 39);
  doc.rect(0, 0, 210, 45, 'F');
  
  // Logo
  doc.setFillColor(59, 130, 246);
  doc.circle(20, 20, 8, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('M', 17.5, 22.5);
  
  // Title
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont(undefined, 'bold');
  doc.text('INVENTORY REPORT', 35, 20);
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Meal Management & Delivery System', 35, 28);
  doc.text('Bahawalpur, Punjab, Pakistan', 35, 34);
  
  doc.setFontSize(9);
  doc.text(`Report Date: ${today}`, 150, 20);

  // Executive Summary
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('Executive Summary', 14, 60);
  
  const summaryY = 70;
  const summaryData = [
    { label: 'Total Inventory Items', value: stats.totalItems, icon: '📦' },
    { label: 'Total Inventory Value', value: `PKR ${stats.totalValue.toLocaleString()}`, icon: '💰' },
    { label: 'Items Below Reorder Level', value: stats.lowStock, icon: '⚠️' },
    { label: 'Active Suppliers', value: stats.suppliers, icon: '🏢' }
  ];

  summaryData.forEach((item, index) => {
    const y = summaryY + (index * 12);
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`${item.icon}  ${item.label}:`, 20, y);
    doc.setFont(undefined, 'bold');
    doc.text(String(item.value), 100, y);
  });

  // Inventory Table
  doc.setFont(undefined, 'bold');
  doc.setFontSize(14);
  doc.text('Inventory Details', 14, summaryY + 60);

  doc.autoTable({
    head: [headers],
    body: rows,
    startY: summaryY + 68,
    theme: 'grid',
    styles: { 
      fontSize: 8,
      cellPadding: 4,
      lineColor: [200, 200, 200],
      lineWidth: 0.1
    },
    headStyles: { 
      fillColor: [17, 24, 39],
      textColor: [255, 255, 255],
      fontStyle: 'bold',
      fontSize: 9,
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 35, fontStyle: 'bold' },
      1: { halign: 'center', cellWidth: 20 },
      2: { halign: 'center', cellWidth: 20 },
      3: { halign: 'center', cellWidth: 20 },
      4: { halign: 'center', cellWidth: 25 },
      5: { cellWidth: 40 },
      6: { halign: 'right', cellWidth: 25 }
    },
    alternateRowStyles: {
      fillColor: [249, 250, 251]
    },
    didParseCell: function(data) {
      if (data.row.index >= 0 && data.column.index === 1) {
        const stock = parseFloat(data.cell.text[0]);
        const reorderLevel = parseFloat(rows[data.row.index][4]);
        if (stock < reorderLevel) {
          data.cell.styles.fillColor = [254, 226, 226];
          data.cell.styles.textColor = [185, 28, 28];
          data.cell.styles.fontStyle = 'bold';
        }
      }
    }
  });

 
 {% endblock %}